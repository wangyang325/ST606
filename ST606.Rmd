---
title: "ST606_W4"
author: "YANG WANG"
date: "2020/4/28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
suppressMessages(library(readxl))
suppressMessages(library(plotly))
suppressMessages(library(randomForest))
suppressMessages(library(dplyr))
suppressMessages(library(GGally))
suppressMessages(library(ggplot2))
suppressMessages(library(scatterplot3d))
suppressMessages(library(sitar))

########################################################
## Clean Data
##
## Delete the data which height and weight = 'NA' (Invalid BMI data)
########################################################
dat_ex_all <- read_excel("./SharedFiles/ST606/2020/data/Exercise/fit_database_anthropometric_all.xlsx", sheet=1, na='NA')

# Clean data (delete all data that the follow conditions are NA)
dat <- subset(dat_ex_all, `height (cm)` != 'NA' 
                & `weight (kg)` != 'NA')
# Change the date to year
dat$mYear <- substr(as.character(dat$`measurement date`), start=1, stop=4)

# Change the colnames
colnames(dat)[10] <- 'z_category'
colnames(dat)[9] <- 'z_score'
colnames(dat)[2] <- 'm_date'
colnames(dat)[3] <- 'age'
colnames(dat)[4] <- 'age_bin'
colnames(dat)[6] <- 'height'
colnames(dat)[7] <- 'weight'

# new age bin by 0.5 year
dat$new_age_bin = as.factor(ifelse((dat$age - dat$age_bin)>= 0.5,dat$age_bin + 0.5 , dat$age_bin))

# delete error data
dat$indx <- paste(dat$ID, dat$new_age_bin, sep='||')
index <- duplicated(dat[,13])
dat_u <- dat[!index, 1:12]

dat_u$ID = as.character(dat_u$ID)

# check the deleted data
dataSta <- data.frame(All = nrow(dat_ex_all), Object = nrow(dat_u), Deleted = nrow(dat_ex_all) - nrow(dat_u)) 
dataSta
```

1. Clean data

a) Deleted the rows which the column of height or the column of weight are NA.

b) Deleted the invalid data(duplicated measure data)

c) All rows: 102642; deleted rows: 7968; Object rows:94674

```{r}
########################################################
## Get the ratio
##  data: input data
##  gender: 0:Girl 1:Boy 2:All
########################################################
getRatio <- function(data, gender) {
  pDataNor <- c()
  pDataObe <- c()
  pDataOver <- c()
  pDataSThin <- c()
  pDataThin <- c()
  # Gender:All
  if (gender == 2) {
    # all 
    for (value in 6:18) {
      norPer <- nrow(data[which(data$z_category=="normal" & data$age_bin==value),])/nrow(data[which(data$age_bin==value),])
      pDataNor <- c(pDataNor, norPer)

      norObe <- nrow(data[which(data$z_category=="obese" & data$age_bin==value ),])/nrow(data[which(data$age_bin==value),])
      pDataObe <- c(pDataObe, norObe)
      
      norOver <- nrow(data[which(data$z_category=="overweight" & data$age_bin==value ),])/nrow(data[which(data$age_bin==value),])
      pDataOver <- c(pDataOver, norOver)
      
      norSThin <- nrow(data[which(data$z_category=="severely thin" & data$age_bin==value ),])/nrow(data[which(data$age_bin==value),])
      pDataSThin <- c(pDataSThin, norSThin)
      
      norThin <- nrow(data[which(data$z_category=="thin" & data$age_bin==value ),])/nrow(data[which(data$age_bin==value),])
      pDataThin <- c(pDataThin, norThin)
    }
    pData <- c(pDataNor, pDataObe, pDataOver, pDataSThin, pDataThin)
    pData
  } 
  # Gender:Boy
  else if (gender == 1) {
    # boy
    for (value in 6:18) {
      norPer <- nrow(data[which(data$z_category=="normal" & data$age_bin==value & data$gender=='boy'),])/nrow(data[which(data$age_bin==value & data$gender=='boy'),])
      pDataNor <- c(pDataNor, norPer)

      norObe <- nrow(data[which(data$z_category=="obese" & data$age_bin==value & data$gender=='boy' ),])/nrow(data[which(data$age_bin==value & data$gender=='boy'),])
      pDataObe <- c(pDataObe, norObe)
      
      norOver <- nrow(data[which(data$z_category=="overweight" & data$age_bin==value & data$gender=='boy' ),])/nrow(data[which(data$age_bin==value & data$gender=='boy'),])
      pDataOver <- c(pDataOver, norOver)
      
      norSThin <- nrow(data[which(data$z_category=="severely thin" & data$age_bin==value & data$gender=='boy' ),])/nrow(data[which(data$age_bin==value & data$gender=='boy'),])
      pDataSThin <- c(pDataSThin, norSThin)
      
      norThin <- nrow(data[which(data$z_category=="thin" & data$age_bin==value & data$gender=='boy' ),])/nrow(data[which(data$age_bin==value & data$gender=='boy'),])
      pDataThin <- c(pDataThin, norThin)
    }
    pData <- c(pDataNor, pDataObe, pDataOver, pDataSThin, pDataThin)
    pData
  } 
  # Gender:Girl
  else if (gender == 0) {
  # girl
    for (value in 6:18) {
      norPer <- nrow(data[which(data$z_category=="normal" & data$age_bin==value & data$gender=='girl'),])/nrow(data[which(data$age_bin==value & data$gender=='girl'),])
      pDataNor <- c(pDataNor, norPer)

      norObe <- nrow(data[which(data$z_category=="obese" & data$age_bin==value & data$gender=='girl' ),])/nrow(data[which(data$age_bin==value & data$gender=='girl'),])
      pDataObe <- c(pDataObe, norObe)
      
      norOver <- nrow(data[which(data$z_category=="overweight" & data$age_bin==value & data$gender=='girl' ),])/nrow(data[which(data$age_bin==value & data$gender=='girl'),])
      pDataOver <- c(pDataOver, norOver)
      
      norSThin <- nrow(data[which(data$z_category=="severely thin" & data$age_bin==value & data$gender=='girl' ),])/nrow(data[which(data$age_bin==value & data$gender=='girl'),])
      pDataSThin <- c(pDataSThin, norSThin)
      
      norThin <- nrow(data[which(data$z_category=="thin" & data$age_bin==value & data$gender=='girl' ),])/nrow(data[which(data$age_bin==value & data$gender=='girl'),])
      pDataThin <- c(pDataThin, norThin)
    }
    pData <- c(pDataNor, pDataObe, pDataOver, pDataSThin, pDataThin)
    pData
  }
}
########################################################
## Show trend chart
##  data: input data
########################################################
showTrend <- function(data, ty) {
    title <- 'The proportion of z_category in 6~18 year-old'
    Age <- rep(6:18, times = 10)
    
    typeB <- rep(c('Normal(Boy)','Obese(Boy)','Overweight(Boy)','Severely thin(Boy)', 'Thin(Boy)'), each = 13)
    typeG <- rep(c('Normal(Girl)','Obese(Girl)','Overweight(Girl)','Severely thin(Girl)', 'Thin(Girl)'), each = 13)
    type <- c(typeB, typeG)
    
    ProportionB <- getRatio(data, 1)
    ProportionG <- getRatio(data, 0)
    Proportion <- c(ProportionB, ProportionG)
    
    genderB <- rep('Boy', times = 65)
    genderG <- rep('Girl', times = 65)
    gender <- c(genderB, genderG)
    
    df <- data.frame(Age = Age, type = type, proportion = Proportion, gender=gender)
    p <- ggplot(data = df, mapping = aes(x = Age, y = Proportion, colour = type)) + geom_line() +
        ggtitle(title)
    
    if (ty == 0) {
      p
    } else {
      p  + facet_wrap(~gender)
    }
}
```

```{r}
########################################################
## z_category By age_bin
##
## Compare the proportion of z_category in 6-18 year-old by gender.
########################################################
# Compare all in the same graph
showTrend(dat_u,0)
# Seperate by gender
showTrend(dat_u,1)
```

The show the proportion of healthy status from 6 to 18 year-old by gender 

For Normal:

  1. Over 60% of teenager are healthy(Normal).
  
  2. 6-9 year-old, the Normal(Boy) is near to Normal(Girl); 9-18 year-old the Normal(Girl) > Normal(Boy).
  
  3. 6-9 year-old for Normal(Boy) declined; 9-18 year-old Normal(Boy) increased. 
  
  4. 6-10 year-old for Normal(Girl) declined; 10-18 year-old Normal(Girl) increased. 

For Severely thin and Thin:
  
  1. The proportion of Severely thin is the lowest and the boy is the same as girl around 0.2%.
  
  2. The proportion of Severely thin is the second lowest and the boy is the same as girl around 2%.

For Obese:

  1. 6-10 year-old, Obese increased
  
  2. 10-18 year-old Obese declined
  
  3. All the period, Obese(Boy) > Obese(Girl) 
  
For Overweight:
  
  1. 6-13 year-old, Overweight increased, Overweight(Girl) > Overweight(Boy).
  
  2. 13-14 year-old, Overweight(Boy) is near to Overweight(Girl).
  
  3. 14-18 year-old, Overweight declined, Overweight(Boy) > Overweight(Girl).
  
For Overweight and Obese'

  1. For Boy:
     a) 6-8 year-old, Overweight(Boy) increased > Obese(Boy) keep the same.
     
     b) 8-10 year-old, Overweight(Boy) increased < Obese(Boy) increased.
     
     c) 10-18 year-old, Overweight(Boy) declined > Obese(Boy) declined.
  
  2. For Girl:
     
     a) Overweight(Girl) > Obese(Girl).
     
     b) 6-10 year-old increased; 10-18 year-old declined.

```{r}
########################################################
## Growth Curve Analysis (Height)
##
## Plot Height versus age_bin by gender  
########################################################
ggplot(dat_u, aes(x=age_bin, y=height, color=z_category)) + geom_point() + geom_smooth(method = "loess", se=FALSE) + facet_wrap(~gender)
```
The graph shows the plot height versus age_bin by gender.

  1. The height(Boy) > height(Girl) in the same age_bin.
  
  2. 6-16 year-old, height grows fast.
  
  3. 17-18 year-old, height grows slowly.
  
  4. The height of Obese(Boy) > Overweight(Boy) > Normal(Boy) > Thin(Boy) > Serverely Thin(Boy).
  
  5. The height of Obese(Girl) > Overweight(Girl) > Normal(Girl) > Serverely Thin(Girl) > Thin(Girl).

```{r}
########################################################
## Growth Curve Analysis (Height)
##
## fit the Height growth curve analysis(Girl)  
########################################################
## The growth curve for girl's height
dat_u_girl <- dat_u[which(dat_u$gender=="girl"),]
fh1 <- sitar(x = age_bin, y = height, id = ID, data = dat_u_girl, df=3, control = nlmeControl(msMaxIter = 500, maxIter = 1000, returnObject = TRUE))

par(mar = c(4,4,1,1) + 0.1, cex = 0.8)
mplot(x = age_bin, y = height, id = ID, data = dat_u_girl, col = ID, las = 1)
plot(fh1, opt = 'a', col = ID, las = 1, xlim = xaxsd(), ylim = yaxsd())
```

The graph shows the Height growth curve analysis(Girl).

  The height has two steps: 6-13 year-old grows fast, 14-18 year-old grows slowly.

```{r}
########################################################
## Growth Curve Analysis (Height)
##
## fit the Height growth curve analysis(Boy)  
########################################################
## The growth curve for boy's height
dat_u_boy <- dat_u[which(dat_u$gender=="boy"),]
fh2 <- sitar(x = age_bin, y = height, id = ID, data = dat_u_boy, df=3, control = nlmeControl(msMaxIter = 500, maxIter = 1000, returnObject = TRUE))

par(mar = c(4,4,1,1) + 0.1, cex = 0.8)
mplot(x = age_bin, y = height, id = ID, data = dat_u_boy, col = ID, las = 1)
plot(fh2, opt = 'a', col = ID, las = 1, xlim = xaxsd(), ylim = yaxsd())
```

The graph shows the Height growth curve analysis(Boy).

  The height has two steps: 6-14 year-old grows fast, 15-18 year-old grows slowly.

```{r}


```